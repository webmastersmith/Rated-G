(()=>{var t={413:(t,n,o)=>{const r=o(24);function i(t="-",e,n){const o=s(1e3*e),r=s(1e3*n);return"+"===t?Math.abs(s((r+o)/1e3)):Math.abs(s((r-o)/1e3))}function a(t,e){const{swearWordString:n,ignoreWords:o}=t,r=new RegExp(`\\b(?:${n})\\b`,"iu");return!(o.some((t=>new RegExp(`\\b${t}\\b`,"i").test(e)))||e.includes("!ignore!")||!r.test(e)&&!/!remove!/.test(e))}function s(t){return+(Math.round(t+"e+3")+"e-3")}async function c(t,e){const n=["-hide_banner","-show_format","-show_streams","-of","json",t],o=await m("ffprobe",n,e,!1);e.write(`Video ${t} Specifications ----------------------------------\n${o}\n\n`)}function d(t){const e=t.split("."),n=e.pop().toLowerCase();return{name:e.join("."),ext:n}}async function l(t,e,n){const o=["-v","quiet","-hide_banner","-print_format","flat","-show_entries","mkv"===e||"avi"===e?"format=duration":"stream=duration","-of","default=noprint_wrappers=1:nokey=1","-select_streams","v:0",`${t}.${e}`];let r=await m("ffprobe",o,n,!1);if(r=+r.trim(),Number.isNaN(r))throw n.write(`Duration was NaN: ${r}\n\n`),new Error(`Duration was NaN: ${r}`);return n.write(`Video Length: Seconds.Milliseconds: ${r}, Time: ${u(r)}\n\n`),r}function u(t){const[e,n="000"]=t.toString().split("."),o=Math.floor(e/3600),r=o.toString().padStart(2,"0"),i=Math.floor(e%3600/60);return`${r}:${i.toString().padStart(2,"0")}:${(e-(3600*o+60*i)).toString().padStart(2,"0")},${n.toString().padEnd(3,"0")}`}async function m(t,n=[],r,i=!0){const{spawn:a}=o(317);return new Promise(((o,s)=>{let c="";try{const e=`Running command: ${t} ${n.join(" ")}\n\n`;r.write(e),console.log(e);const d=a(t,n);d.stdout.on("data",(t=>{i&&console.log(t.toString()),c+=t})),d.stderr.on("data",(t=>{i&&console.log(t.toString()),c+=t})),d.on("close",(e=>{if(0===e)o(c);else{const o=new Error(`Command "${t} ${n.join(" ")}" exited with code ${e}`);o.code=e,o.stdout=c,r.write(`Error: Command "${t} ${n.join(" ")}" exited with code ${e}.\n${c}\n\n`),s(o)}})),d.on("error",(t=>{r.write(t.toString()),s(t)}))}catch(o){r.write(`Error: Command "${t} ${n.join(" ")}" exited with error.\nSTDOUT: ${c}\nERROR: ${e}\n\n`),s(o)}}))}function p(t){if(!t)return"";const[e,n,o,r=0]=t.split(/:|,/);return+`${60*+e*60+60*+n+ +o}.${r}`}t.exports={addSwearWords:function(t,e=[]){const n=Array.isArray(e)?e:e.split(" ");return t.concat(n).join("|")},containsSwearWords:a,convertMsToTime:function(t){function e(t){return t.toString().padStart(2,"0")}let n=Math.floor(t/1e3),o=Math.floor(n/60),r=Math.floor(o/60);return n%=60,o%=60,r%=24,`${e(r)}:${e(o)}:${e(n)}`},deleteFiles:function(t,e){e.write(`Deleting files: ${t.join(", ")}\n`);for(const n of t)r.existsSync(n)?(r.unlinkSync(n),console.log("[34m",`${n} was deleted`),console.log("[0m",""),e.write(`${n} was deleted\n`)):(console.log("[34m",`File ${n} was not found!`),console.log("[0m",""),e.write(`File ${n} was not found!\n`));e.write("\n\n")},extractSubtitle:async function(t,e){const{video:n,args:o,subName:r}=t,i=["-hide_banner","-v","error","-i",n,"-map",`0:s:${o["subtitle-number"]?o["subtitle-number"]:0}`,r];console.log("[34m",`Could not find Subtitle. Trying to Extract ${r}`),console.log("[0m",""),e.write(`Could not find subtitle ${r}. Trying to extract from ${n}.\n\n`);try{const t=await m("ffmpeg",i,e);return e.write(`extractSubtitles:\nstdout: ${t}\n\n`),console.log("[34m",`Extracted ${r}`),console.log("[0m",""),e.write(`Extracted ${r} from ${n}`),!0}catch(t){return console.log("No srt found!",t),e.write(`No srt found! ${t}\n\n`),!1}},filterGraphAndEncode:async function(t,e,n=[]){const{args:o,ext:i,name:a,subName:s,cleanSubName:d,cleanVideoName:l,video:u,videoMeta:p}=t,w=!o?.cpu;let $=o?.quality?+o.quality:27;Number.isNaN($)&&($=26);const f=o?.["audio-number"]?o["audio-number"]:0,g=["-pix_fmt","yuv420p","-profile",o?.h264?"high":"main","-c:v",o?.h264?"h264_nvenc":"hevc_nvenc"],h=[...o?.["10-bit"]?["-pix_fmt","p010le","-profile:v","main10","-c:v","hevc_nvenc"]:g,"-r",p.frameRate,...o?.smallest?["-preset","p7","-multipass",2]:["-preset","p1","-multipass",0],"-b:v",0,"-bf",0,"-g",300,"-me_range",36,"-subq",9,"-keyint_min",1,"-qdiff",20,"-qcomp",.9,"-qmin",17,"-qmax",51,"-qp",$,"-rc","constqp","-tune","hq","-rc-lookahead",4,"-keyint_min",1,"-qdiff",20,"-qcomp",.9],b=["-c:v",o?.h265?"libx265":"libx264","-crf",$],S=["-c:a",p.audioCodec,"-b:a",p.audioBitRate,"-ar",p.audioSampleRate],v=["-map_metadata","-1",...o?.["no-chapters"]?["-map_chapters","-1"]:""],N=["-metadata",`creation_time=${(new Date).toISOString()}`,"-metadata",`title='${a}'`],x=r.existsSync(d),y=["-c:s",o?.copy&&"mkv"===i?"srt":"mov_text","-metadata:s:s:0","language=eng"];let T=["-map","0:v","-map",`0:a:${f}`];if(!o?.skip){let t="",e=0,r="";for(const[o,[i,a]]of n.entries())t+=`[0:v]trim=start=${i}:end=${a},setpts=PTS-STARTPTS[${o}v];[0:a:${f}]atrim=start=${i}:end=${a},asetpts=PTS-STARTPTS[${o}a];`,r+=`[${o}v][${o}a]`,e++;if(T=["-filter_complex",`${t}${r} concat=n=${e}:v=1:a=1[outv][outa]`,"-map","[outv]","-map","[outa]"],o?.["video-filter"]){const t=n.map((([t,e])=>`between(t,${t},${e})`));T=["-vf",`select='${t.join("+")}', setpts=N/FRAME_RATE/TB`,"-af",`aselect='${t.join("+")}', asetpts=N/SAMPLE_RATE/TB`]}}const _=["-y",o?.report?"-report":"","-hide_banner","-v","error","-stats",...w?["-hwaccel","cuda"]:"","-i",u,...x?["-i",d]:"",...w?h:b,...x?y:"",...S,...v,...N,...T,...x&&!o?.["video-filter"]?["-map","1:s:0"]:"","-strict","experimental",l],R=["-y",o?.report?"-report":"","-hide_banner","-v","error","-stats","-i",u,..."mkv"===i?["-f","srt"]:"","-i",s,..."mkv"===i?["-map","0:0","-map","0:1","-map","1:0"]:"","-c:v","copy","-c:a","copy",...v,...N,...y,`${a}-withSubtitle.${i}`],k=await m("ffmpeg",o?.copy?R.filter((t=>""!==t)):_.filter((t=>""!==t)),e);e.write(`filterGraphAndEncode: --------------------------------------------------\n${k}\n\n`),o?.copy?await c(`${a}-withSubtitle.${i}`,e):await c(t.cleanVideoName,e)},getArgs:function(){return Object.fromEntries(process.argv.slice(2).join(" ").split(/ -{1,2}/).map((t=>{console.log("arg",t);const e=t.trim().toLowerCase().replace(/^-{1,2}/,"").split(/=/);return e.length<2&&e.push(!0),e})).filter((t=>!!t[0])))},getCuts:async function(t,e){const{name:n,args:o,ext:s,frameRate:c,subName:d,cleanSubName:l,videoMeta:m}=t,w=function(t,e){try{const n=r.readFileSync(t,"utf-8").split(/\r?\n\r?\n\d{1,5}\r?\n?$/m).map(((t,e)=>{let n="",o="";e>0?[n,...o]=t.trim().split(/\r?\n/):[_,n,...o]=t.trim().split(/\r?\n/);const[r,i]=n.split(" --\x3e ");return{id:e+1,start:r,end:i,text:o.join("\n").trim()}})),o=n.reduce(((t,e)=>{const{id:n,start:o,end:r,text:i}=e;return t+`${n}\n${o} --\x3e ${r}\n${i}\n\n`}),"");return e.write(`splitSubtitles:\n${o}\n\n`),n}catch(n){const o=`\n[31m${t} Read Error:\n[33mThere was a problem parsing the subtitle ${t}.\nCheck the first line in ${t} is a number.\nThe problem could also be file header corruption:\n  Copy ${t} contents into a new file and save. \n  Delete old srt file.\n  Rename new file as: ${t}[0m\n\n\n\n`;throw e.write(`${o}`),new Error(o)}}(d,e);e.write("Swear Words Keeps ----------------------------------------------\n\tSRT Time\tSeconds\tFrame\n");const $=[],f=[];let g=0,h="";const b=[];let S=0;for(const[n,o]of w.entries()){let{id:r,start:s,end:d,text:l}=o;const m=Math.floor(p(s)),w=Math.ceil(p(d));if(a(t,l)){if(0===m){S=w;const t=Math.abs(w-m);g+=t,h+=`Start time was zero. Seconds removed: ${t}.\t`}else{if(Math.abs(m-S)>=2){const t=`between(t,${S},${m})`;b.push([S,m]);const n=Math.abs(w-m);g+=n,h+=`${t}\tSecondsRemoved: ${n}\t`,e.write(`Start:\t${s}\t${m}\t${m*c}\nEnd:\t${d}\t${w}\t${w*c}\n\n`)}else{const t=Math.abs(w-S);g+=t,h+=`Time was less than two seconds! Skipping!\t\tSecondsRemoved: ${t}\t`}S=w}f.push({id:r,start:s,end:d,text:l})}else{const t=u(i("-",p(s),g)),e=u(i("-",p(d),g));l.includes("!ignore!")&&(l=l.replace("!ignore!","")),$.push({id:r,start:t,end:e,text:l})}h+=`index: ${n}, \tid: ${r}\ts: ${S},\tstart: ${m}s, ${s}\tend: ${w}s, ${d}\t\tTotalSecondsRemoved: ${g}s.\n`}S<m.duration&&b.push([S,Math.floor(m.duration)]),e.write(`Keep Video Segments ---------------------------------------\n${JSON.stringify(b)}\n\n`),e.write(`getCuts: -keepStr. This logs the time removed from subtitles.\n${h}\n\n`);const v=$.map(((t,e)=>({...t,id:e+1}))).reduce(((t,e)=>{const{id:n,start:o,end:r,text:i}=e;return t+`${n}\n${o} --\x3e ${r}\n${i}\n\n`}),"");r.writeFileSync(l,v),e.write(`${l}\n${v}\n\n`);const N=f.reduce(((t,e)=>{const{id:n,start:o,end:r,text:i}=e;return t+`${o} - ${r} \t${i.trim().replace(/\r?\n/g," ")}\n`}),"");return e.write(`getCuts: -Swear Words\n${N}\n\n`),b},getName:d,getMetadata:async function(t,e,n){const{name:o,ext:r}=d(t),i=["-v","quiet","-hide_banner","-show_format","-show_streams","-of","json",t],a=await m("ffprobe",i,n,!1),s=JSON.parse(a),c=e?.["audio-number"]?+e["audio-number"]+1:0,p=[],w=[];for(const t of s?.streams)"video"===t?.codec_type?.toLowerCase()&&p.push(t),"audio"===t?.codec_type?.toLowerCase()&&w.push(t);const $=p[0],f=w[c];let g=24;const h=$?.r_frame_rate,b=h?.split("/");if(2!==b.length)throw new Error("Video Frame Rate not Found.");const[S,v]=b;Number.isNaN(+S)||Number.isNaN(+v)?n.write("Frame Rate Not Found. -----------------------------\n\n"):g=+(+S/+v).toFixed(3);let N=+f?.sample_rate,x=e?.["audio-bitrate"]?e["audio-bitrate"]:+f?.bit_rate,y=e?.["audio-codec"]?e["audio-codec"]:f?.codec_name;(Number.isNaN(N)||Number.isNaN(x)||!y)&&(n.write(`Audio Codec Problem. Using defaults. -----------------------\nAudio Sample Rate: ${N}\nAudio Bit Rate: ${x}\nAudio Codec: ${y}\n\n`),N=48e3,x=e?.["audio-bitrate"]?e["audio-bitrate"]:"448k",y="ac3");const T=await l(o,r,n);return{frameRateString:h,frameRate:g,audioSampleRate:N,audioBitRate:x,audioCodec:y,duration:T,time:u(T)}},getVideoDuration:l,getVideoNames:function(){const t=["\\.mp4$","\\.mkv$","\\.avi$","\\.webm$"],e=new RegExp(t.join("|")),n=new RegExp(["output","clean","temp","sanitize","withSubtitle"].map((e=>t.map((t=>`${e}${t}`)).join("|"))).join("|")),o=r.readdirSync(process.cwd()).filter((t=>e.test(t))).filter((t=>!n.test(t)));return console.log(o),o},recordMetadata:c,spawnShell:m,transcribeVideo:async function(t,e){const{video:n}=t,o=`Could not extract subtitles from ${n}.\nStarting Docker with AI transcription.\nThis will take a few minutes to transcribe video.\n\n`;e.write(o),console.log("[35m",o),console.log("[0m","");const r=["run","--rm","-v",`${process.cwd()}:/data`,"-v",`${process.cwd()}/.whisper:/app/.whisper`,"jveldboom/video-swear-jar:v1","clean","--input",n,"--model","tiny.en","--language","en"],i=await m("docker",r,e);e.write(`transcribeVideo:\nstdout: ${i}\n\n`)},zipVideo:async function(t,e){const{video:n,subName:o,name:r}=t,i=await m("7z",["a","-t7z",`${r}.7z`,n,o],e);e.write(`zip:\nstdout: ${i}\n\n`)}}},317:t=>{"use strict";t.exports=require("child_process")},24:t=>{"use strict";t.exports=require("node:fs")},937:t=>{"use strict";t.exports=JSON.parse('["arse","ass","ass.?ho\\\\w*","bitch\\\\w*","bullshit\\\\w*","blow.?job","chicken.?shit\\\\w*","cock","cocksucker.*","cum (?!laude)","cumming","cumshot.?","cunnilingus","cunt","damn\\\\w*","(?<!charles )dick(?!ens)\\\\w*(?! chen)","dildo","dyke","dumbass.*","fuck\\\\w*","god.?damn\\\\w*","holy.?shit","horseshit","masturbate","moth\\\\w*.?fuck\\\\w*","nigg\\\\w*","penis\\\\w*","puss\\\\w*(y|s)","shit\\\\w*","smartass","[^\\\\p{L}]tits?","titt\\\\w*","twat","vagina"]')}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,o),i.exports}(async()=>{const t=o(24),{addSwearWords:e,convertMsToTime:n,deleteFiles:r,extractSubtitle:i,filterGraphAndEncode:a,getArgs:s,getCuts:c,getName:d,getMetadata:l,getVideoNames:u,recordMetadata:m,transcribeVideo:p,zipVideo:w}=o(413),$=o(937),f=s(),g=u();for(const o of g){const s=(new Date).getTime();console.log(o);const{name:u,ext:h}=d(o),b=`${u}.log`,S=t.createWriteStream(b);f.clean=!0===f?.zip;try{S.write(`Video Names ------------------------------------\n${g.join("\n")}\n\n`);const d=await l(o,f,S),v={args:f,cleanSubName:`${u}-clean.srt`,cleanVideoName:`${u}-clean.mp4`,ext:h,name:u,logName:b,subName:`${u}.srt`,swearWordString:e($,f?.add?.split(" ")??[]),ignoreWords:f?.ignore?.split(" ")??[],transcribeVideo:!1,video:o,videoMeta:d};if(S.write(`State -------------------------------------------\n${JSON.stringify(v,null,2)}\n\n`),await m(v.video,S),!f?.skip)if(t.existsSync(v.subName))S.write(`Subtitle ${v.subName} found!\n\n`);else if(!await i(v,S)){v.args.skip=!0;const t=await p(v,S);if(console.log("out",t),/No swear words found/.test(t?.stdout||"")){console.log("[35m","Transcription done! No swear words found."),console.log("[0m",""),S.write("Transcription done! No swear words found.\n\n");const t=(new Date).getTime();S.write(`Time to Complete ${o}: ${n(t-s)}\n\n`),S.end();continue}v.video=`${v.name}-output.${v.ext}`,await a(v,S);const e=[`${u}-cut.txt`,`${u}.json`,v.video,`${u}-cut-words.txt`];f.debug||r(e,S);const i=(new Date).getTime();S.write(`Time to Complete ${o}: ${n(i-s)}\n\n`),S.end();continue}let N=[];f?.skip||(N=f.copy?[]:await c(v,S)),await a(v,S,N),f?.zip&&await w(v,S);const x=[v.cleanSubName];f?.clean&&x.push(v.video,v.subName,"clean.txt"),f?.["clean-all"]&&x.push(v.video,v.subName,v.logName),f?.debug||r(x,S);const y=(new Date).getTime();S.write(`Time to Complete ${o}: ${n(y-s)}\n\n`),S.end()}catch(t){S.end(),S.on("close",(()=>{throw new Error(t)}))}}})()})();